# Bazel Illumos (and somewhat Solaris) port

**(Scroll down for original Bazel README.md)**

This repo contains a Illumos port of Bazel. This port currently assumes the use of pkgsrc. 

Previous version of this port used Solaris as a target name but this version specifically targets Illumos. Among things because I don't want to hijack the Solaris target name since this is acutally a Illumos port. With a little effort (couple of `ifdef`'s) it can probably also be made to work on Solaris. Since I personally don't have a specific need for such a port it's not here. However if you would like to adopt this port for use on Solaris and run into any issues while doing so please feel free to reach out to me (via issues, Twitter, etc.).

## Building Bazel on SmartOS

Create a SmartOS container (joyent brand if your on Triton). To build and use Bazel you need an image which has GCC7. It's easiest to use an image which also uses GCC7 by default. This guide assumes you use image `ad6f47f2-c691-11ea-a6a5-cf0776f07bb7` (20.2.0) with GCC 7.5. Beware that currently the `7.5.0` path is hardcoded in the Bazel 2.2.0 path (see known issues).

Install required build packages:

```
# pkgin -y install git-base zip unzip openjdk8 libtool cmake automake ninja-build autoconf gmake gcc7
```

Next we need to download the Bazel distribution and apply the changes of this forked repo. The reason why we need the Bazel distribution and can't simply compile the cloned fork is because in order to compile Bazel you need a working Bazel installation (usually an older version). The Bazel distribution contains things like pre-compiled protobuf messages (ie. java files generated by the protobuf compiler). 

Download `bazel-2.2.0-dist.zip` (the Bazel distribution) from the [Bazel releases](https://github.com/bazelbuild/bazel/releases) page.

Next we will prepare our source tree by putting everything together:

```
# mkdir bazel-2.2.0
# unzip bazel-2.2.0-dist.zip -d bazel-2.2.0
# git clone https://github.com/siepkes/bazel-smartos.git
# cd bazel-smartos
# git checkout smartos-2.2.0
# git format-patch -1
# cd ../bazel-2.2.0
# patch -p1 < ../bazel-smartos/0001-Modifications-to-port-Bazel-2.2.0-to-Illumos-SmartOS.patch
```

We are now ready to build Bazel!

```
# export JAVA_HOME="/opt/local/java/openjdk8"
# export EXTRA_BAZEL_ARGS="--host_javabase=@local_jdk//:jdk"
# ./compile.sh
```

Grab a `<INSERT FAVORITE BEVERAGE HERE>` and wait for the build to complete.

## Debugging Bazel build problems

When encountering issues with building Bazel the following `EXTRA_BAZEL_ARGS` can be set to get more information during the build. See the [Bazel Command Line Reference](https://docs.bazel.build/versions/master/command-line-reference.html) for more flags.

```
# export EXTRA_BAZEL_ARGS="--subcommands --host_javabase=@local_jdk//:jdk"
```

## Notes on porting to Illumos

This port is dependent on the [platforms](https://github.com/siepkes/platforms) definition repository.

## Known issues

* `bazel/tools/cpp/CROSSTOOL` contains a hardcoded GCC version number in some paths. For example `/opt/local/gcc7/lib/gcc/x86_64-sun-solaris2.11/7.5.0/include-fixed`. This can break with GCC updates and will result in errors like when for example `7.3.0` is configured in Bazel instead of `7.5.0`: 

```
ERROR: /root/.cache/bazel/_bazel_root/7558a64af10a6eb79f74e70211660103/external/com_google_protobuf/BUILD:414:1: undeclared inclusion(s) in rule '@com_google_protobuf//:protoc':
this rule is missing dependency declarations for the following files included by 'external/com_google_protobuf/src/google/protobuf/compiler/main.cc':
  '/opt/local/gcc7/lib/gcc/x86_64-sun-solaris2.11/7.5.0/include/stddef.h'
  '/opt/local/gcc7/lib/gcc/x86_64-sun-solaris2.11/7.5.0/include/stdint.h'
Target //source/exe:envoy-static failed to build
```

* There are some `FIXME:` entries added to the code base which describe ugly hacks which have been applied. If these changes are ever to be upstreamed these would likely need to be addressed.

# Original Bazel README.md

*{Fast, Correct} - Choose two*

Build and test software of any size, quickly and reliably.

* **Speed up your builds and tests**:
  Bazel rebuilds only what is necessary.
  With advanced local and distributed caching, optimized dependency analysis and
  parallel execution, you get fast and incremental builds.

* **One tool, multiple languages**: Build and test Java, C++, Android, iOS, Go,
  and a wide variety of other language platforms. Bazel runs on Windows, macOS,
  and Linux.

* **Scalable**: Bazel helps you scale your organization, codebase, and
  continuous integration solution. It handles codebases of any size, in multiple
  repositories or a huge monorepo.

* **Extensible to your needs**: Easily add support for new languages and
  platforms with Bazel's familiar extension language. Share and re-use language
  rules written by the growing Bazel community.

## Getting Started

  * [Install Bazel](https://docs.bazel.build/install.html)
  * [Get started with Bazel](https://docs.bazel.build/getting-started.html)
  * Follow our tutorials:

    - [Build C++](https://docs.bazel.build/tutorial/cpp.html)
    - [Build Java](https://docs.bazel.build/tutorial/java.html)
    - [Android](https://docs.bazel.build/tutorial/android-app.html)
    - [iOS](https://docs.bazel.build/tutorial/ios-app.html)

## Documentation

  * [Bazel command line](https://docs.bazel.build/user-manual.html)
  * [Rule reference](https://docs.bazel.build/be/overview.html)
  * [Use the query command](https://docs.bazel.build/query.html)
  * [Extend Bazel](https://docs.bazel.build/skylark/concepts.html)
  * [Write tests](https://docs.bazel.build/test-encyclopedia.html)
  * [Roadmap](https://bazel.build/roadmap.html)
  * [Who is using Bazel?](https://github.com/bazelbuild/bazel/wiki/Bazel-Users)

## Contributing to Bazel

See [CONTRIBUTING.md](CONTRIBUTING.md)

[![Build status](https://badge.buildkite.com/1fd282f8ad98c3fb10758a821e5313576356709dd7d11e9618.svg?status=master)](https://ci.bazel.build)
